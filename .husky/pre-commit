# Run linter
echo "üîç Running linter..."
npm run lint || {
  echo "‚ùå Linting failed. Please fix errors before committing."
  exit 1
}

# Run build to check TypeScript
echo "üî® Building project..."
npm run build || {
  echo "‚ùå Build failed. Please fix TypeScript errors before committing."
  exit 1
}

# Run tests
echo "üß™ Running tests..."
npm run test:run || {
  echo "‚ùå Tests failed. Please fix failing tests before committing."
  exit 1
}

# Check if CHANGELOG was updated (skip for release commits)
COMMIT_MSG_FILE=".git/COMMIT_EDITMSG"
if [ -f "$COMMIT_MSG_FILE" ] && grep -q "chore(release):" "$COMMIT_MSG_FILE" 2>/dev/null; then
  # Skip check for release commits
  :
elif ! git diff --cached --name-only | grep -q "CHANGELOG.md"; then
  # Check if commit message suggests a feature/fix
  if git diff --cached --name-only | grep -qE "^src/"; then
    echo ""
    echo "‚ö†Ô∏è  WARNING: CHANGELOG.md not updated."
    echo "üí° Consider running 'npm run release' before committing features/fixes."
    echo ""
    echo "To bypass this check, commit with --no-verify"
    # Uncomment next line to make it blocking:
    # exit 1
  fi
fi

echo "‚úÖ Pre-commit checks passed!"
